<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>
    
      深入了解 Laravel 5.5 包自动发现
    
  </title>
  
    <link rel="icon" href="/favicon.png">
  
  <link href="https://cdn.bootcss.com/normalize/8.0.1/normalize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono" rel="stylesheet">
  <link href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/index.css">
  <script src="/js/index.js"></script>

  
    <link href="https://cdn.bootcss.com/highlight.js/9.13.1/styles/github.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/highlight.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/ada.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/cpp.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/css.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/dart.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/dockerfile.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/elixir.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/erlang.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/go.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/haskell.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/ini.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/java.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/javascript.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/json.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/julia.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/kotlin.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/python.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/protobuf.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/r.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/lisp.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/llvm.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/lua.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/makefile.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.0/languages/markdown.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/ruby.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/rust.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/scala.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/scss.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/shell.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/sql.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/swift.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/tex.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/typescript.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/verilog.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/vim.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/xml.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.13.1/languages/yaml.min.js"></script>
  
</head>

  <body>
    <aside id="menu">
  <header>
    <div class="wrapper">
      <button class="close"><i class="fas fa-times"></i></button>
      <h1 class="title">WHITE</h1>
    </div>
  </header>
  <div class="wrapper">
    <div class="description">
      Hello Goodbye & Hello
    </div>
    <nav>
      <ul>
        
          
            <li><a href="/">Home</a></li>
          
        
          
            <li><a href="/tags">Tags</a></li>
          
        
          
            <li><a href="/about">About</a></li>
          
        
          
            <li><a href="/atom.xml">Rss</a></li>
          
        
      </ul>
    </nav>
    <ul class="social">
      
        <li>
          <a target="__bank" href="https://github.com/helbing">
            <i class="fab fa-github"></i>
          </a>
        </li>
      
        <li>
          <a target="__bank" href="mailto:helbingxxx@gmail.com">
            <i class="fas fa-at"></i>
          </a>
        </li>
      
    </ul>
    <footer>
      &copy;
      <a target="__bank" href="https://github.com/helbing">helbing</a> -
      Powered by <a target="__bank" href="https://hexo.io">Hexo</a> & <a target="__bank" href="https://github.com/helbing/hexo-theme-white">White</a>.
    </footer>
  </div>
</aside>

    <header class="fixed">
  <div class="wrapper">
    <button id="menu-btn"><i class="fas fa-bars"></i></button>
    <h1 class="title">WHITE</h1>
    <button id="search-btn"><i class="fas fa-search"></i></button>
  </div>
</header>

    <aside id="search">
  <div class="wrapper">
    <header>
      <input type="text" id="search-input" placeholder="Input And Enter To Search">
      <button class="close"><i class="fas fa-times"></i></button>
    </header>
    <div id="search-result"></div>
    <div class="back-to-top">
  <button><i class="fas fa-angle-up"></i>TOP</button>
</div>

  </div>
</aside>

    <div class="container">
      <main>
        
          

<article class="article">
  <div class="cover left-item" style="background-image:url(https://tuchuang-1253782374.cos.ap-guangzhou.myqcloud.com/20190211132629.png);">
    <img src="https://tuchuang-1253782374.cos.ap-guangzhou.myqcloud.com/20190211132629.png">
  </div>
  <div class="content right-item">
    <div class="wrapper">
      <time>NOVEMBER 3, 2018</time>
      <h2 class="title">
        <a href="/2018/11/03/package-auto-discovery/">深入了解 Laravel 5.5 包自动发现</a>
      </h2>
      <div class="description">
        laravel5.5 开始提供了一个新特性，包自动发现 Package Auto Discuvery，包自动发现主要用于自动发现第三方包的 ServiceProvider 和 Facade 并进行注册
      </div>
      <ul class="tags">
        
          
            <li><a href="/tags/php/">#php</a></li>
          
        
          
            <li><a href="/tags/laravel/">#laravel</a></li>
          
        
      </ul>
    </div>
  </div>
</article>

          <div id="article">
            <h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>第三方包只需要在自己的 composer.json 文件中加入需要注册的 ServiceProvider 和 Facade，laravel 的 package auto discovery 就会自动发现并注册</p>
<pre><code class="json">&quot;extra&quot;: {
    &quot;laravel&quot;: {
        &quot;providers&quot;: [
            &quot;Barryvdh\\Debugbar\\ServiceProvider&quot;
        ],
        &quot;aliases&quot;: {
            &quot;Debugbar&quot;: &quot;Barryvdh\\Debugbar\\Facade&quot;
        }
    }
},
</code></pre>
<p>如果你不想 laravel 对某个包做自动发现，你可以在你 laravel 项目的 composer.json 中加入</p>
<pre><code class="json">&quot;extra&quot;: {
    &quot;laravel&quot;: {
        &quot;dont-discover&quot;: &quot;barryvdh/laravel-debugbar&quot;
    }
},
</code></pre>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><pre><code class="json">&quot;scripts&quot;: {
    &quot;post-root-package-install&quot;: [
        &quot;@php -r \&quot;file_exists(&#39;.env&#39;) || copy(&#39;.env.example&#39;, &#39;.env&#39;);\&quot;&quot;
    ],
    &quot;post-create-project-cmd&quot;: [
        &quot;@php artisan key:generate --ansi&quot;
    ],
    &quot;post-autoload-dump&quot;: [
        &quot;Illuminate\\Foundation\\ComposerScripts::postAutoloadDump&quot;,
        &quot;@php artisan package:discover --ansi&quot;
    ]
},
</code></pre>
<p>laravel 的 package auto discovery 主要是通过<code>php artisan package:discover --ansi</code>这条命令来执行的，这条命令位于<code>Illuminate\Foundation\Console\PackageDiscoverCommand</code>这个类中，这个类会调用<code>Illuminate\Foundation\PackageManifest</code>的 build 方法来做自动发现</p>
<pre><code class="php">public function build()
{
    $packages = [];

    // installed.json是composer在安装完所有包后会自动生成的文件，其实就是所有包的composer.json的集合
    if ($this-&gt;files-&gt;exists($path = $this-&gt;vendorPath . &#39;/composer/installed.json&#39;)) {
        $packages = json_decode($this-&gt;files-&gt;get($path), true);
    }

    // $this-&gt;packagesToIgnore()会获取到当前laravel项目的composer.json中不需要做自动发现的包
    $ignoreAll = in_array(&#39;*&#39;, $ignore = $this-&gt;packagesToIgnore());

    // 这个很长的调用其实是获取到每一个需要自动注册的ServiceProvider和Facade
    // 然后将结果作为参数传入write方法
    $this-&gt;write(collect($packages)-&gt;mapWithKeys(function ($package) {
        return [$this-&gt;format($package[&#39;name&#39;]) =&gt; $package[&#39;extra&#39;][&#39;laravel&#39;] ?? []];
    })-&gt;each(function ($configuration) use (&amp;$ignore) {
        $ignore = array_merge($ignore, $configuration[&#39;dont-discover&#39;] ?? []);
    })-&gt;reject(function ($configuration, $package) use ($ignore, $ignoreAll) {
        return $ignoreAll || in_array($package, $ignore);
    })-&gt;filter()-&gt;all());
}

protected function write(array $manifest)
{
    // $this-&gt;manifestPath这个的值从哪里来的？你可以去看Illuminate\Foundation\Application的registerBaseBindings方法
    // $this-&gt;manifestPath的值一般会是bootstrap/cache/packages.php
    if (!is_writable(dirname($this-&gt;manifestPath))) {
        throw new Exception(&#39;The &#39; . dirname($this-&gt;manifestPath) . &#39; directory must be present and writable.&#39;);
    }

    // 单纯的把自动发现到的ServiceProvider和Facade写入到文件中
    $this-&gt;files-&gt;replace(
        $this-&gt;manifestPath,
        &#39;&lt;?php return &#39; . var_export($manifest, true) . &#39;;&#39;
    );
}
</code></pre>
<p>然后这条命令就算是执行完成了，单纯的只是做了自动发现，那么自动注册呢？</p>
<p>全局搜索 PackageManifest，可以发现<code>Illuminate\Foundation\Application</code>中的 registerConfiguredProviders 有调用到</p>
<pre><code class="php">public function registerConfiguredProviders()
{
    // 获取到app.php中所有需要注册的ServiceProvider
    $providers = Collection::make($this-&gt;config[&#39;app.providers&#39;])
        -&gt;partition(function ($provider) {
            return Str::startsWith($provider, &#39;Illuminate\\&#39;);
        });

    // 获取到自动发现到的所有需要注册的ServiceProvider
    $providers-&gt;splice(1, 0, [$this-&gt;make(PackageManifest::class)-&gt;providers()]);

    // 这里函数调用会去注册ServiceProvider
    (new ProviderRepository($this, new Filesystem(), $this-&gt;getCachedServicesPath()))
        -&gt;load($providers-&gt;collapse()-&gt;toArray());
}
</code></pre>
<p>继续全局搜索 PackageManifest，可以发现<code>Illuminate\Foundation\Bootstrap\RegisterFacades</code>中的 bootstrap 有调用到</p>
<pre><code class="php">public function bootstrap(Application $app)
{
    Facade::clearResolvedInstances();

    Facade::setFacadeApplication($app);

    // 注册Facade
    AliasLoader::getInstance(array_merge(
        // 获取到app.php中所有需要注册的Facade
        $app-&gt;make(&#39;config&#39;)-&gt;get(&#39;app.aliases&#39;, []),
        // 获取到自动发现到的所有需要注册的Facade
        $app-&gt;make(PackageManifest::class)-&gt;aliases()
    ))-&gt;register();
}
</code></pre>

          </div>
          
          
          <ul class="paginate">
  <li>
    <a href="/2019/02/04/deploy-hexo-blog-with-travis/"><i class="fas fa-arrow-left"></i>&nbsp;PREV</a>
  </li>
  
  <li>
    <a href="javascript:void(0)">NEXT&nbsp;<i class="fas fa-arrow-right"></i></a>
  </li>
</ul>

          
            <div id="disqus_thread"></div>
            <script>
              var disqus_config = function () {
                this.page.url = "https://blog.helbing.cn/2018/11/03/package-auto-discovery/";
                this.page.identifier = "https://blog.helbing.cn/2018/11/03/package-auto-discovery/";
              };
              (function() {
                var d = document, s = d.createElement('script');
                s.src = "https://blog-helbing-cn.disqus.com/embed.js";
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
          <div class="back-to-top">
  <button><i class="fas fa-angle-up"></i>TOP</button>
</div>

        
      </main>
    </div>
  </body>
</html>
